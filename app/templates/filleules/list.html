{% extends "base.html" %}

{% block title %}Liste des Filleules{% endblock %}

{% block content %}
<div class="flex flex-col gap-4 mb-6 sm:flex-row sm:items-center sm:justify-between">
    <div>
        <p class="text-sm uppercase tracking-[0.2em] text-[#F2932B] font-semibold">Filleules</p>
        <h2 class="font-display text-2xl">Les prot√©g√©es Afoulki üëß</h2>
        <p class="text-slate-600 text-sm">Un aper√ßu rapide des profils et villages.</p>
    </div>
    <div class="flex flex-wrap items-center gap-3">
        <a href="/filleules/html/pdf{% if request.url.query %}?{{ request.url.query }}{% endif %}"
           class="inline-flex items-center gap-2 rounded-full border border-[#4969A430] bg-[#4969A418] px-4 py-2 text-sm font-semibold text-[#4969A4] hover:-translate-y-0.5 transition shadow-soft"
           target="_blank" rel="noopener">
            PDF
        </a>
        <div class="bg-[#F2932B10] border border-[#F2932B20] text-[#F2932B] px-4 py-3 rounded-2xl shadow-soft text-sm">
            üåº Merci pour votre accompagnement bienveillant.
        </div>
    </div>
</div>

<div class="flex flex-wrap items-center gap-3 mb-6">
    <a href="/filleules/html?sans_parrains=1"
       class="inline-flex items-center gap-2 rounded-full border border-[#F2932B30] bg-[#F2932B14] px-4 py-2 text-sm font-semibold text-[#F2932B] hover:-translate-y-0.5 transition shadow-soft">
        Filleules / Parrains/Marraines ({{ count_without_parrains }})
    </a>
    <a href="/filleules/html?couverture_sante=1"
       class="inline-flex items-center gap-2 rounded-full border border-[#4969A430] bg-[#4969A41f] px-4 py-2 text-sm font-semibold text-[#4969A4] hover:-translate-y-0.5 transition shadow-soft">
        Couverture sant√© ({{ count_couverture_sante }})
    </a>
    {% if showing_without_parrains or showing_couverture_sante %}
    <a href="/filleules/html"
       class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 hover:-translate-y-0.5 transition shadow-soft">
        Voir toutes les filleules
    </a>
    {% endif %}
</div>
<div class="overflow-hidden rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft">
    <table class="min-w-full table-fixed text-left text-sm">
        <thead class="bg-gradient-to-r from-[#F2932B14] via-[#F2A75A20] to-[#4969A420] text-slate-700">
            <tr>
                <th class="w-[24%] px-4 py-0.5 text-xs font-semibold uppercase tracking-wide">
                    <div class="flex flex-col gap-2">
                        <span>Nom</span>
                        <input data-col="0" class="filleules-filter w-full rounded-lg border border-slate-200 bg-white/80 px-2 py-0.5 text-xs normal-case font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#F2932B40]" placeholder="Filtrer">
                    </div>
                </th>
                <th class="px-4 py-0.5 text-xs font-semibold uppercase tracking-wide">
                    <div class="flex flex-col gap-2">
                        <span>Pr√©nom</span>
                        <input data-col="1" class="filleules-filter w-full rounded-lg border border-slate-200 bg-white/80 px-2 py-0.5 text-xs normal-case font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#F2932B40]" placeholder="Filtrer">
                    </div>
                </th>
                <th class="w-24 px-4 py-0.5 text-xs font-semibold uppercase tracking-wide text-center">
                    <div class="flex flex-col gap-2">
                        <span>Entr√©e au FAE</span>
                        <input data-col="2" class="filleules-filter w-full rounded-lg border border-slate-200 bg-white/80 px-2 py-0.5 text-xs normal-case font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#F2932B40]" placeholder="Filtrer">
                    </div>
                </th>
                <th class="w-[20%] px-4 py-0.5 text-xs font-semibold uppercase tracking-wide">
                    <div class="flex flex-col gap-2">
                        <span>R√©f√©rent</span>
                        <input data-col="3" class="filleules-filter w-full rounded-lg border border-slate-200 bg-white/80 px-2 py-0.5 text-xs normal-case font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#F2932B40]" placeholder="Filtrer">
                    </div>
                </th>
                <th class="px-4 py-0.5 text-xs font-semibold uppercase tracking-wide">
                    <div class="flex flex-col gap-2">
                        <span>√âtablissement</span>
                        <input data-col="4" class="filleules-filter w-full rounded-lg border border-slate-200 bg-white/80 px-2 py-0.5 text-xs normal-case font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#F2932B40]" placeholder="Filtrer">
                    </div>
                </th>
                <th class="px-4 py-0.5 text-xs font-semibold uppercase tracking-wide text-right">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-[#F2932B14]">
            {% for f in filleules %}
            {% set latest = recent_scolarite.get(f.id_filleule) %}
            <tr class="hover:bg-[#F2932B0f] transition">
                <td class="w-[24%] px-4 py-0.5">{{ f.nom }}</td>
                <td class="px-4 py-0.5">{{ f.prenom }}</td>
                <td class="w-24 px-4 py-0.5 text-center">{{ f.annee_rentree if f.annee_rentree else "-" }}</td>
                <td class="w-[20%] px-4 py-0.5">
                    {% if f.correspondant %}
                        {{ f.correspondant.prenom }} {{ f.correspondant.nom }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="w-[30%] px-4 py-0.5">{{ latest.etablissement if latest else "-" }}</td>
                <td class="px-4 py-0.5 text-right">
                    <a href="/filleules/html/{{ f.id_filleule }}" class="inline-flex items-center gap-2 text-[#F2932B] font-semibold hover:translate-x-1 transition">
                        Voir <span>‚Üí</span>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="flex flex-wrap items-center justify-between gap-3 px-4 py-3 border-t border-[#F2932B14] bg-white/80 text-sm">
        <div id="filleules-range" class="text-slate-600">Affichage 0-0 sur 0</div>
        <div class="flex items-center gap-2">
            <button type="button" id="filleules-prev" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:-translate-y-0.5 transition disabled:opacity-50 disabled:cursor-not-allowed">
                ‚Üê Pr√©c.
            </button>
            <span id="filleules-page" class="text-slate-600"></span>
            <button type="button" id="filleules-next" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:-translate-y-0.5 transition disabled:opacity-50 disabled:cursor-not-allowed">
                Suiv. ‚Üí
            </button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const table = document.querySelector("table");
        if (!table) {
            return;
        }
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const filters = Array.from(table.querySelectorAll(".filleules-filter"));
        const perPage = 20;
        let currentPage = 1;
        const pageLabel = document.getElementById("filleules-page");
        const rangeLabel = document.getElementById("filleules-range");
        const prevButton = document.getElementById("filleules-prev");
        const nextButton = document.getElementById("filleules-next");
        const normalize = (value) => value.toLowerCase().trim();
        const getFilteredRows = () => {
            return rows.filter((row) => {
                const cells = row.querySelectorAll("td");
                return filters.every((input) => {
                    const query = normalize(input.value);
                    if (!query) {
                        return true;
                    }
                    const col = Number(input.dataset.col);
                    const cell = cells[col];
                    if (!cell) {
                        return true;
                    }
                    return normalize(cell.textContent).includes(query);
                });
            });
        };
        const renderPage = () => {
            const filteredRows = getFilteredRows();
            const totalPages = Math.max(1, Math.ceil(filteredRows.length / perPage));
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            rows.forEach((row) => row.classList.add("hidden"));
            filteredRows.slice(start, end).forEach((row) => row.classList.remove("hidden"));
            if (pageLabel) {
                pageLabel.textContent = `Page ${currentPage} / ${totalPages}`;
            }
            if (rangeLabel) {
                if (!filteredRows.length) {
                    rangeLabel.textContent = "Aucun r√©sultat";
                } else {
                    const startIndex = start + 1;
                    const endIndex = Math.min(end, filteredRows.length);
                    rangeLabel.textContent = `Affichage ${startIndex}-${endIndex} sur ${filteredRows.length}`;
                }
            }
            if (prevButton) {
                prevButton.disabled = currentPage === 1;
            }
            if (nextButton) {
                nextButton.disabled = currentPage === totalPages;
            }
        };
        if (prevButton) {
            prevButton.addEventListener("click", () => {
                currentPage = Math.max(1, currentPage - 1);
                renderPage();
            });
        }
        if (nextButton) {
            nextButton.addEventListener("click", () => {
                currentPage = currentPage + 1;
                renderPage();
            });
        }
        filters.forEach((input) => {
            input.addEventListener("input", () => {
                currentPage = 1;
                renderPage();
            });
        });
        renderPage();
    });
</script>
{% endblock %}
