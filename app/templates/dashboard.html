{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-8">

    {% if request.state.user %}
    <div class="pt-10 border-t border-[#F2932B1f] space-y-8">
        <div class="bg-gradient-to-r from-[#F2932B] via-[#F2A75A] to-[#4969A4] text-white rounded-3xl p-8 shadow-2xl shadow-[rgba(73,105,164,0.35)]">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="font-display text-3xl">Suivi des indicateurs üéâ</h1>
                </div>
                <div class="flex items-center gap-3 bg-white/15 rounded-2xl px-4 py-3 shadow-soft">
                    <span class="text-3xl">üìà</span>
                    <div class="text-sm">
                        <p class="font-semibold">Vue d'ensemble</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid gap-4 md:grid-cols-4">
            <a href="#filieres" class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                <p class="text-sm text-slate-500">Filleules</p>
                <p class="text-3xl font-display text-[#F2932B]">{{ stats.filleules }}</p>
            </a>
            <a href="/parrains/html" class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                <p class="text-sm text-slate-500">Parrains</p>
                <p class="text-3xl font-display text-[#4969A4]">{{ stats.parrains }}</p>
            </a>
            <div class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center">
                <p class="text-sm text-slate-500">Parrainages</p>
                <p class="text-3xl font-display text-[#F2932B]">{{ stats.parrainages }}</p>
            </div>
            <div class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center">
                <p class="text-sm text-slate-500">Documents</p>
                <p class="text-3xl font-display text-[#4969A4]">{{ stats.documents }}</p>
            </div>
            <a href="/correspondants/html" class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                <p class="text-sm text-slate-500">R√©f√©rents</p>
                <p class="text-3xl font-display text-[#4969A4]">{{ stats.referents }}</p>
            </a>
            <a href="#scolarites" class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                <p class="text-sm text-slate-500">Scolarit√©s</p>
                <p class="text-3xl font-display text-[#4969A4]">{{ stats.annees_scolaires }}</p>
            </a>
            <a href="#villes-origine" class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                <p class="text-sm text-slate-500">Villes d'origine</p>
                <p class="text-3xl font-display text-[#F2932B]">{{ stats.localites }}</p>
            </a>
            <a href="/filleules/html?couverture_sante=1"
               class="rounded-2xl bg-white/95 border border-[#F2932B1f] shadow-soft p-5 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                <p class="text-sm text-slate-500">Couverture sant√©</p>
                <p class="text-3xl font-display text-[#4969A4]">{{ stats.couverture_sante }}</p>
            </a>
        </div>

        <details id="scolarites" class="rounded-3xl bg-white/95 border border-[#F2932B1f] shadow-soft p-6 sm:p-8 scroll-mt-24" data-dashboard-accordion>
            <summary class="cursor-pointer">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm uppercase tracking-[0.2em] text-[#F2932B] font-semibold">Scolarit√©s</p>
                        <h3 class="font-display text-2xl">Ann√©es scolaires</h3>
                        <p class="text-slate-600 text-sm">Choisissez une ann√©e pour filtrer la liste des scolarit√©s.</p>
                    </div>
                    <div class="text-xs text-slate-500 bg-[#F2932B10] border border-[#F2932B20] px-3 py-2 rounded-2xl">
                        ‚óè {{ stats.annees_scolaires }} ann√©es disponibles
                    </div>
                </div>
            </summary>

            <div class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                {% for annee in annees_scolaires %}
                <a href="/scolarite/html?annee={{ annee.periode | urlencode }}"
                   class="flex flex-col items-center gap-1 rounded-2xl border border-[#F2932B1f] bg-[#F2932B0f] px-4 py-3 text-center transition hover:-translate-y-0.5 hover:shadow-soft">
                    <span class="text-sm font-semibold text-slate-700">{{ annee.periode }} ({{ annee.count }})</span>
                </a>
                {% endfor %}
                {% if not annees_scolaires %}
                <p class="text-slate-500 text-sm">Aucune ann√©e scolaire renseign√©e.</p>
                {% endif %}
            </div>
        </details>

        <details id="filieres" class="rounded-3xl bg-white/95 border border-[#F2932B1f] shadow-soft p-6 sm:p-8 scroll-mt-24" data-dashboard-accordion>
            <summary class="cursor-pointer">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm uppercase tracking-[0.2em] text-[#F2932B] font-semibold">Fili√®res</p>
                        <h3 class="font-display text-2xl">Parcours des filleules</h3>
                        <p class="text-slate-600 text-sm">R√©partition des fili√®res sur l'ann√©e en cours.</p>
                    </div>
                    <div class="text-xs text-slate-500 bg-[#F2932B10] border border-[#F2932B20] px-3 py-2 rounded-2xl">
                        ‚óè Total bas√© sur la derni√®re scolarit√© connue
                    </div>
                </div>
            </summary>

            <div class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                {% for filiere in filiere_stats %}
                <a href="/filleules/html?filiere={{ filiere.name | urlencode }}"
                   class="flex items-center justify-between gap-3 rounded-2xl border border-[#F2932B1f] bg-[#F2932B0f] px-4 py-3 transition hover:-translate-y-0.5 hover:shadow-soft">
                    <span class="text-sm font-semibold text-slate-700">{{ filiere.name }}</span>
                    <span class="text-lg font-display text-[#4969A4]">{{ filiere.count }}</span>
                </a>
                {% endfor %}
                {% if not filiere_stats %}
                <p class="text-slate-500 text-sm">Aucune fili√®re renseign√©e.</p>
                {% endif %}
            </div>
        </details>

        {% if map_json != "null" %}
        <details id="villes-origine" class="relative overflow-hidden rounded-3xl bg-white/95 border border-[#F2932B1f] shadow-soft p-6 sm:p-8 scroll-mt-24" data-dashboard-accordion>
            <summary class="cursor-pointer">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm uppercase tracking-[0.2em] text-[#F2932B] font-semibold">Villes d'origine</p>
                        <h3 class="font-display text-2xl">Province d'Essaouira</h3>
                        <p class="text-slate-600 text-sm">Rep√©rez les villes d'origine des enfants et le nombre par ville.</p>
                    </div>
                    <div class="text-xs text-slate-500 bg-[#F2932B10] border border-[#F2932B20] px-3 py-2 rounded-2xl">
                        ‚óè Taille du point = nombre d'enfants
                    </div>
                </div>
            </summary>

            <div class="mt-6 grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
                <div class="rounded-2xl border border-[#F2932B1f] bg-[#F2932B08] p-4 overflow-hidden">
                    <svg id="essaouira-map" class="w-full h-auto" role="img" aria-label="Carte de la province d'Essaouira">
                        <g id="essaouira-paths"></g>
                        <g id="essaouira-points"></g>
                    </svg>
                </div>
                <div class="rounded-2xl border border-[#F2932B1f] bg-white/90 p-4">
                    <p class="text-sm font-semibold text-slate-700 mb-3">Villes et effectifs</p>
                    <div class="grid gap-2 text-sm text-slate-700 sm:grid-cols-2">
                        {% for city in city_stats.cities | sort(attribute='count', reverse=true) %}
                        <button type="button"
                                class="city-list-item flex items-center justify-between gap-2 border border-slate-200 rounded-xl px-3 py-2 text-left transition hover:-translate-y-0.5 hover:shadow-soft"
                                data-city-name="{{ city.name }}">
                            <span>{{ city.name }}</span>
                            <span class="font-semibold text-[#4969A4]">{{ city.count }}</span>
                        </button>
                        {% endfor %}
                        {% if not city_stats.cities %}
                        <p class="text-slate-500 text-sm">Aucune ville renseign√©e.</p>
                        {% endif %}
                    </div>
                    {% if city_stats.missing %}
                    <p class="mt-3 text-xs text-slate-500">
                        Villes sans coordonn√©es : {{ city_stats.missing | join(", ") }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div id="city-filleules-modal" class="absolute inset-0 z-20 hidden items-center justify-center p-4 sm:p-6">
                <button type="button" class="absolute inset-0 rounded-3xl bg-slate-900/50" data-city-modal-close></button>
                <div class="relative w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-8 max-h-full overflow-y-auto">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <p class="text-sm uppercase tracking-[0.2em] text-[#F2932B] font-semibold">Ville d'origine</p>
                            <h3 id="city-modal-title" class="font-display text-2xl"></h3>
                        </div>
                        <button type="button"
                                class="city-modal-close h-10 w-10 rounded-full border border-slate-200 text-slate-500 hover:text-slate-800 hover:border-slate-300 transition"
                                aria-label="Fermer">
                            ‚úï
                        </button>
                    </div>
                    <p id="city-modal-empty" class="mt-4 text-slate-500 text-sm hidden">Aucune filleule.</p>
                    <ul id="city-modal-list" class="mt-4 grid gap-2 sm:grid-cols-2"></ul>
                </div>
            </div>
        </details>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if request.state.user %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const mapData = {{ map_json | safe }};
        const cityPoints = {{ city_json | safe }};
        const svg = document.getElementById("essaouira-map");
        const pathsLayer = document.getElementById("essaouira-paths");
        const pointsLayer = document.getElementById("essaouira-points");
        if (mapData && svg && pathsLayer && pointsLayer) {
            svg.setAttribute("viewBox", `0 0 ${mapData.width} ${mapData.height}`);

            const svgNS = "http://www.w3.org/2000/svg";
            mapData.paths.forEach((pathData) => {
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathData);
                path.setAttribute("fill", "rgba(242,147,43,0.12)");
                path.setAttribute("stroke", "#F2932B");
                path.setAttribute("stroke-width", "1.5");
                pathsLayer.appendChild(path);
            });

            const { min_lon, max_lon, min_lat, max_lat } = mapData.bounds;
            const width = mapData.width;
            const height = mapData.height;

            const project = (lon, lat) => {
                const x = ((lon - min_lon) / (max_lon - min_lon)) * width;
                const y = ((max_lat - lat) / (max_lat - min_lat)) * height;
                return { x, y };
            };

            cityPoints.forEach((city) => {
                if (typeof city.lat !== "number" || typeof city.lon !== "number") {
                    return;
                }
                const point = project(city.lon, city.lat);
                const radius = Math.max(4, Math.min(14, 4 + Math.sqrt(city.count) * 2));

                const group = document.createElementNS(svgNS, "g");
                group.setAttribute("transform", `translate(${point.x}, ${point.y})`);

                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("r", radius);
                circle.setAttribute("fill", "#4969A4");
                circle.setAttribute("stroke", "#ffffff");
                circle.setAttribute("stroke-width", "2");

                const label = document.createElementNS(svgNS, "text");
                label.setAttribute("x", radius + 6);
                label.setAttribute("y", 4);
                label.setAttribute("font-size", "12");
                label.setAttribute("fill", "#1f2937");
                label.textContent = `${city.name} (${city.count})`;

                const title = document.createElementNS(svgNS, "title");
                title.textContent = `${city.name} : ${city.count}`;

                group.appendChild(circle);
                group.appendChild(label);
                group.appendChild(title);
                pointsLayer.appendChild(group);
            });
        }

        const listButtons = Array.from(document.querySelectorAll(".city-list-item"));
        const accordionPanels = Array.from(document.querySelectorAll("details[data-dashboard-accordion]"));
        const modal = document.getElementById("city-filleules-modal");
        const modalTitle = document.getElementById("city-modal-title");
        const modalList = document.getElementById("city-modal-list");
        const modalEmpty = document.getElementById("city-modal-empty");

        const openModal = (cityName) => {
            if (!modal || !modalTitle || !modalList || !modalEmpty) {
                return;
            }
            const city = cityPoints.find((item) => item.name === cityName);
            modalTitle.textContent = cityName;
            modalList.innerHTML = "";
            const filleules = city && Array.isArray(city.filleules) ? city.filleules : [];
            if (!filleules.length) {
                modalEmpty.classList.remove("hidden");
            } else {
                modalEmpty.classList.add("hidden");
                filleules.forEach((filleule) => {
                    const li = document.createElement("li");
                    const link = document.createElement("a");
                    const fullName = `${filleule.prenom || ""} ${filleule.nom || ""}`.trim();
                    link.textContent = fullName || "Filleule";
                    link.href = `/filleules/html/${filleule.id}`;
                    link.className = "text-[#F2932B] font-semibold hover:underline";
                    li.appendChild(link);
                    modalList.appendChild(li);
                });
            }
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            document.body.classList.add("overflow-hidden");
        };

        const closeModal = () => {
            if (!modal) {
                return;
            }
            modal.classList.add("hidden");
            modal.classList.remove("flex");
            document.body.classList.remove("overflow-hidden");
        };

        listButtons.forEach((button) => {
            button.addEventListener("click", () => {
                openModal(button.dataset.cityName || "");
            });
        });

        accordionPanels.forEach((panel) => {
            panel.addEventListener("toggle", () => {
                if (!panel.open) {
                    return;
                }
                accordionPanels.forEach((otherPanel) => {
                    if (otherPanel !== panel) {
                        otherPanel.removeAttribute("open");
                    }
                });
                panel.scrollIntoView({ behavior: "smooth", block: "start" });
            });
        });

        const openAccordion = (panel) => {
            if (!panel) {
                return;
            }
            panel.setAttribute("open", "");
            accordionPanels.forEach((otherPanel) => {
                if (otherPanel !== panel) {
                    otherPanel.removeAttribute("open");
                }
            });
            panel.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        const filieresPanel = document.getElementById("filieres");
        const filieresLinks = Array.from(document.querySelectorAll('a[href="#filieres"]'));
        filieresLinks.forEach((link) => {
            link.addEventListener("click", (event) => {
                event.preventDefault();
                openAccordion(filieresPanel);
            });
        });

        const villesPanel = document.getElementById("villes-origine");
        const villesLinks = Array.from(document.querySelectorAll('a[href="#villes-origine"]'));
        villesLinks.forEach((link) => {
            link.addEventListener("click", (event) => {
                event.preventDefault();
                openAccordion(villesPanel);
            });
        });

        const scolaritesPanel = document.getElementById("scolarites");
        const scolaritesLinks = Array.from(document.querySelectorAll('a[href="#scolarites"]'));
        scolaritesLinks.forEach((link) => {
            link.addEventListener("click", (event) => {
                event.preventDefault();
                openAccordion(scolaritesPanel);
            });
        });

        const closeButton = modal ? modal.querySelector(".city-modal-close") : null;
        const overlay = modal ? modal.querySelector("[data-city-modal-close]") : null;
        if (closeButton) {
            closeButton.addEventListener("click", closeModal);
        }
        if (overlay) {
            overlay.addEventListener("click", closeModal);
        }
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closeModal();
            }
        });

    });
</script>
{% endif %}
{% endblock %}
